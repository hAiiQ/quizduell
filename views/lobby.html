<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeopardy - Lobby</title>
    <link rel="stylesheet" href="/css/style.css?v=1.3">
    <style>
        /* Jitsi Individual Tiles Styling */
        .jitsi-tiles-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .jitsi-individual-tiles {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }
        
        /* Custom Jitsi styling for individual tiles */
        .jitsi-individual-tiles iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        
        /* Override Jitsi default styles for tile view */
        .jitsi-individual-tiles .jitsi-watermark {
            display: none !important;
        }
        
        .jitsi-controls-panel {
            background: #333;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .jitsi-control-btn {
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .jitsi-control-btn:hover {
            background: #0052a3;
        }
        
        .jitsi-control-btn.active {
            background: #28a745;
        }
        
        .jitsi-control-btn.muted {
            background: #dc3545;
        }
        
        .jitsi-info-panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            color: #ccc;
            font-size: 13px;
        }
        
        .jitsi-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .jitsi-status-connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .jitsi-status-connecting {
            background: #FFC107;
            animation: pulse 1s infinite;
        }
        
        .jitsi-status-disconnected {
            background: #F44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .participants-counter {
            display: inline-block;
            background: #0066cc;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lobby-screen">
            <h1>Lobby <span id="lobbyId"></span></h1>
            
            <div class="lobby-info">
                <div class="admin-section">
                    <h3>Admin</h3>
                    <div id="adminInfo" class="player-card admin-card">
                        <span class="player-name"></span>
                        <span class="admin-badge">ADMIN</span>
                    </div>
                </div>
                
                <div class="players-section">
                    <h3>Spieler (<span id="playerCount">0</span>/4)</h3>
                    <div id="playersList" class="players-list">
                        <!-- Players will be added dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Jitsi Individual Tiles Section -->
            <div class="webcam-section">
                <h3>üé• Video Chat - Individuelle Kameras</h3>
                
                <div class="jitsi-tiles-container">
                    <div class="jitsi-status-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 8px 12px; background: #333; border-radius: 6px;">
                        <div>
                            <span id="jitsi-status-indicator" class="jitsi-status-indicator jitsi-status-connecting"></span>
                            <span id="jitsi-status-text" style="color: #ccc; font-size: 12px;">Verbinde...</span>
                            <span id="participants-count" class="participants-counter">0</span>
                        </div>
                        <div>
                            <span style="color: #888; font-size: 11px;">Raum: </span>
                            <span id="jitsi-room-name" style="color: #4CAF50; font-size: 12px; font-family: monospace;">jeopardy-lobby-<span id="lobby-code-display"></span></span>
                        </div>
                    </div>
                    
                    <!-- Main Jitsi Container for Individual Tiles -->
                    <div id="jitsi-individual-container" class="jitsi-individual-tiles">
                        <!-- Jitsi will be embedded here with tile view -->
                        <div id="jitsi-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üé•</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">Video-Chat wird geladen...</div>
                            <div style="font-size: 12px; color: #888;">Jitsi Meet - Individuelle Kameras</div>
                            <div style="margin-top: 10px;">
                                <div class="loading-spinner" style="border: 2px solid #333; border-top: 2px solid #0066cc; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jitsi Controls -->
                    <div class="jitsi-controls-panel">
                        <button id="jitsi-toggle-camera" class="jitsi-control-btn" onclick="toggleJitsiCamera()" title="Kamera ein/aus">
                            üìπ Kamera
                        </button>
                        <button id="jitsi-toggle-audio" class="jitsi-control-btn" onclick="toggleJitsiAudio()" title="Mikrofon ein/aus">
                            üé§ Mikrofon
                        </button>
                        <button id="jitsi-tile-view" class="jitsi-control-btn active" onclick="enableJitsiTileView()" title="Kachel-Ansicht">
                            üî≤ Kacheln
                        </button>
                        <button id="jitsi-fullscreen" class="jitsi-control-btn" onclick="toggleJitsiFullscreen()" title="Vollbild">
                            ‚õ∂ Vollbild
                        </button>
                    </div>
                </div>
                
                <!-- Jitsi Info Panel -->
                <div class="jitsi-info-panel">
                    <div style="margin-bottom: 8px; color: #4CAF50; font-weight: bold;">üí° Jitsi Meet - Individuelle Kameras:</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; font-size: 12px; color: #bbb;">
                        <div>üìπ Jeder Spieler in separater Kachel</div>
                        <div>üé§ Individuelle Audio/Video-Kontrolle</div>
                        <div>üî≤ Automatische Kachel-Ansicht aktiv</div>
                        <div>üåê Stabile Jitsi-Server-Verbindung</div>
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; font-size: 11px; color: #888;">
                        <strong>Tipp:</strong> Kachel-Ansicht zeigt alle Teilnehmer individuell - perfekt f√ºr das Jeopardy Spiel!
                    </div>
                </div>
            </div>

            <div class="lobby-actions" id="adminActions" style="display: none;">
                <button id="startGameBtn" class="primary-btn">Spiel starten</button>
            </div>
            
            <div class="lobby-actions">
                <button id="leaveLobbyBtn" class="secondary-btn">Lobby verlassen</button>
            </div>
        </div>
    </div>

    <!-- Include Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Jitsi Meet API -->
    <script src="https://meet.jit.si/external_api.js"></script>
    
    <!-- Jitsi Individual Tiles JavaScript -->
    <script>
        // Jitsi API instance
        let jitsiApi = null;
        let jitsiRoomName = '';
        let isJitsiReady = false;
        let participantCount = 0;
        
        // Jitsi configuration for individual tiles
        const jitsiConfig = {
            startWithAudioMuted: false,
            startWithVideoMuted: false,
            enableWelcomePage: false,
            enableUserRolesBasedOnToken: false,
            prejoinPageEnabled: false,
            disableInviteFunctions: true,
            doNotStoreRoom: true,
            enableNoisyMicDetection: false,
            
            // Force tile view for individual cameras
            defaultLocalDisplayName: 'Du',
            enableLayerSuspension: true,
            
            // UI Configuration for tile view
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'settings', 'videoquality'
                ],
                SETTINGS_SECTIONS: ['devices', 'moderator'],
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_BRAND_WATERMARK: false,
                BRAND_WATERMARK_LINK: '',
                SHOW_POWERED_BY: false,
                GENERATE_ROOMNAMES_ON_WELCOME_PAGE: false,
                DISPLAY_WELCOME_PAGE_CONTENT: false,
                APP_NAME: 'Jeopardy Video Chat',
                DEFAULT_BACKGROUND: '#1a1a1a',
                DISABLE_DOMINANT_SPEAKER_INDICATOR: false,
                DISABLE_FOCUS_INDICATOR: false,
                DISABLE_JOIN_LEAVE_NOTIFICATIONS: false,
                DISABLE_PRESENCE_STATUS: false,
                HIDE_INVITE_MORE_HEADER: true,
                INITIAL_TOOLBAR_TIMEOUT: 20000,
                TOOLBAR_TIMEOUT: 4000,
                TILE_VIEW_MAX_COLUMNS: 4
            },
            
            // Configure for best tile view experience
            conferenceInfo: {
                alwaysVisible: false,
                autoHide: [
                    'subject',
                    'conference-timer',
                    'participants-count',
                    'e2ee',
                    'transcribing',
                    'video-quality'
                ]
            }
        };
        
        // Initialize Jitsi when page loads
        function initializeJitsiTiles() {
            const lobbyCode = document.getElementById('lobbyId').textContent;
            jitsiRoomName = `jeopardy-lobby-${lobbyCode}`;
            
            console.log(`üé• Initializing Jitsi Individual Tiles for room: ${jitsiRoomName}`);
            
            // Update room name displays
            const roomNameElement = document.getElementById('lobby-code-display');
            if (roomNameElement) {
                roomNameElement.textContent = lobbyCode;
            }
            
            // Create Jitsi API instance
            try {
                jitsiApi = new JitsiMeetExternalAPI('meet.jit.si', {
                    roomName: jitsiRoomName,
                    parentNode: document.getElementById('jitsi-individual-container'),
                    width: '100%',
                    height: '100%',
                    configOverwrite: jitsiConfig,
                    interfaceConfigOverwrite: jitsiConfig.interfaceConfigOverwrite,
                    userInfo: {
                        displayName: getPlayerDisplayName()
                    }
                });
                
                setupJitsiEventListeners();
                
            } catch (error) {
                console.error('‚ùå Error initializing Jitsi:', error);
                showJitsiError('Jitsi konnte nicht geladen werden');
            }
        }
        
        // Setup Jitsi event listeners
        function setupJitsiEventListeners() {
            // Conference joined
            jitsiApi.addEventListener('videoConferenceJoined', (event) => {
                console.log('‚úÖ Jitsi conference joined:', event);
                isJitsiReady = true;
                updateJitsiStatus('connected', 'Verbunden');
                hideJitsiLoading();
                
                // Force tile view after joining
                setTimeout(() => {
                    enableJitsiTileView();
                }, 1000);
            });
            
            // Participant joined
            jitsiApi.addEventListener('participantJoined', (event) => {
                console.log('üë§ Participant joined:', event);
                participantCount++;
                updateParticipantCount();
                
                // Ensure tile view is enabled
                setTimeout(() => {
                    enableJitsiTileView();
                }, 500);
            });
            
            // Participant left
            jitsiApi.addEventListener('participantLeft', (event) => {
                console.log('üëã Participant left:', event);
                participantCount = Math.max(0, participantCount - 1);
                updateParticipantCount();
            });
            
            // Ready to close
            jitsiApi.addEventListener('readyToClose', () => {
                console.log('üö™ Jitsi ready to close');
                cleanupJitsi();
            });
            
            // Error handling
            jitsiApi.addEventListener('error', (event) => {
                console.error('‚ùå Jitsi error:', event);
                showJitsiError('Verbindungsfehler');
            });
        }
        
        // Jitsi control functions
        function toggleJitsiCamera() {
            if (jitsiApi && isJitsiReady) {
                jitsiApi.executeCommand('toggleVideo');
                
                const btn = document.getElementById('jitsi-toggle-camera');
                btn.classList.toggle('active');
                console.log('üìπ Toggled camera');
            }
        }
        
        function toggleJitsiAudio() {
            if (jitsiApi && isJitsiReady) {
                jitsiApi.executeCommand('toggleAudio');
                
                const btn = document.getElementById('jitsi-toggle-audio');
                btn.classList.toggle('muted');
                console.log('üé§ Toggled audio');
            }
        }
        
        function enableJitsiTileView() {
            if (jitsiApi && isJitsiReady) {
                jitsiApi.executeCommand('setTileView', true);
                
                const btn = document.getElementById('jitsi-tile-view');
                btn.classList.add('active');
                console.log('üî≤ Enabled tile view');
            }
        }
        
        function toggleJitsiFullscreen() {
            if (jitsiApi && isJitsiReady) {
                jitsiApi.executeCommand('toggleFilmStrip');
                console.log('‚õ∂ Toggled fullscreen');
            }
        }
        
        // Helper functions
        function getPlayerDisplayName() {
            const playerData = sessionStorage.getItem('playerData');
            if (playerData) {
                const data = JSON.parse(playerData);
                return data.isAdmin ? `üëë ${data.name}` : `üë§ ${data.name}`;
            }
            return 'Spieler';
        }
        
        function updateJitsiStatus(status, text) {
            const indicator = document.getElementById('jitsi-status-indicator');
            const statusText = document.getElementById('jitsi-status-text');
            
            if (indicator && statusText) {
                indicator.className = `jitsi-status-indicator jitsi-status-${status}`;
                statusText.textContent = text;
            }
        }
        
        function updateParticipantCount() {
            const countElement = document.getElementById('participants-count');
            if (countElement) {
                countElement.textContent = participantCount + 1; // +1 for self
            }
        }
        
        function hideJitsiLoading() {
            const loading = document.getElementById('jitsi-loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }
        
        function showJitsiError(message) {
            const loading = document.getElementById('jitsi-loading');
            if (loading) {
                loading.innerHTML = `
                    <div style="color: #dc3545; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">Fehler</div>
                        <div style="font-size: 12px;">${message}</div>
                    </div>
                `;
            }
            updateJitsiStatus('disconnected', 'Fehler');
        }
        
        function cleanupJitsi() {
            if (jitsiApi) {
                try {
                    jitsiApi.dispose();
                } catch (error) {
                    console.warn('Warning disposing Jitsi API:', error);
                }
                jitsiApi = null;
            }
            isJitsiReady = false;
            participantCount = 0;
        }
        
        // CSS loading animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé• Jitsi Individual Tiles system ready');
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupJitsi);
    </script>
    
    <!-- Main lobby logic -->
    <script src="/js/lobby.js?v=1.3"></script>
</body>
</html>